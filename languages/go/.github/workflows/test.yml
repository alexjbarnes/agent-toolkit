# Reusable test workflow. Runs tests with race detector and coverage.
# Fails if coverage drops below the threshold.
# Optionally updates a Gist-backed coverage badge on main.

name: Test

on:
  workflow_call:
    inputs:
      update-badge:
        description: Update the coverage badge gist
        required: false
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests with coverage
        run: |
          go test -race -coverprofile=coverage.raw ./...
          # Strip generated files from the coverage profile so they don't
          # drag down the percentage. Add patterns as needed for your project
          # (e.g. _templ.go for templ, mock_*.go for mockgen, *.pb.go for protobuf).
          grep -v -E '_templ\.go|mock_.*\.go|\.pb\.go' coverage.raw > coverage.out

      - name: Check coverage threshold
        id: coverage
        run: |
          total=$(go tool cover -func=coverage.out | grep ^total: | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${total}%"
          echo "total=${total}" >> "$GITHUB_OUTPUT"
          if [ "$(echo "$total < 80" | bc)" -eq 1 ]; then
            echo "::error::Coverage ${total}% is below 80% threshold"
            exit 1
          fi

      # Badge is powered by a Gist + shields.io endpoint badge.
      # Setup: create a Gist, add a GIST_TOKEN secret with gist scope.
      # <!-- TODO: customise -- replace gistID with your own -->
      - name: Update coverage badge
        if: inputs.update-badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: your-gist-id-here
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.total }}%
          valColorRange: ${{ steps.coverage.outputs.total }}
          minColorRange: 60
          maxColorRange: 80
