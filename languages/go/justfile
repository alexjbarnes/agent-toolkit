# <!-- TODO: customise app_name to match your cmd/ directory -->
app_name := "your-app"

# Build variables
version := `git describe --tags --always --dirty 2>/dev/null || echo "dev"`
ldflags := "-X main.Version=" + version

# Build the binary into bin/
build:
    go build -ldflags "{{ldflags}}" -o bin/{{app_name}} ./cmd/{{app_name}}

# Run locally without building
run:
    go run -ldflags "{{ldflags}}" ./cmd/{{app_name}}

# Run all tests with race detector
test:
    go test -v -race ./...

# Run tests and generate an HTML coverage report
test-coverage:
    go test -coverprofile=coverage.out ./...
    go tool cover -func=coverage.out | tail -1
    go tool cover -html=coverage.out -o coverage.html
    @echo "Coverage report: coverage.html"

# Run linter
lint:
    golangci-lint run

# Run linter with auto-fix
lint-fix:
    golangci-lint run --fix

# Format code with gofumpt (falls back to gofmt if gofumpt is not installed)
fmt:
    @which gofumpt > /dev/null 2>&1 && gofumpt -w . || gofmt -w .

# Tidy module dependencies
tidy:
    go mod tidy

# Remove build artifacts
clean:
    rm -rf bin/ coverage.out coverage.html

# Pre-push check: lint, test, and build
check: lint test build
